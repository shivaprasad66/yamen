// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  FOUNDER
  CONTRIBUTOR
  BOTH
}

enum IdeaStatus {
  OPEN
  CLOSED
}

enum Currency {
  SOL
  USDC
}

enum FeedbackStatus {
  PENDING
  SHORTLISTED
  ACCEPTED
  REJECTED
}

enum PayoutStatus {
  PENDING
  SENT
  FAILED
}

model User {
  id            String    @id @default(uuid())
  walletAddress String    @unique
  name          String?
  role          UserRole  @default(CONTRIBUTOR)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  ideasPosted   Idea[]    @relation("FounderIdeas")
  feedbacks     Feedback[]
  payouts       Payout[]

  @@index([walletAddress])
}

model Idea {
  id                        String        @id @default(uuid())
  founderId                 String
  title                     String
  description               String        @db.Text
  context                   String?       @db.Text
  status                    IdeaStatus    @default(OPEN)
  currency                  Currency
  totalBudget               Decimal       @db.Decimal(18, 8)
  rewardPerAcceptedFeedback Decimal       @db.Decimal(18, 8)
  maxAcceptedFeedbacks      Int
  acceptedCount             Int           @default(0)
  escrowTxSignature         String?
  createdAt                 DateTime      @default(now())
  updatedAt                 DateTime      @updatedAt

  // Relations
  founder                   User          @relation("FounderIdeas", fields: [founderId], references: [id])
  feedbacks                 Feedback[]
  payouts                   Payout[]
  activityLogs              IdeaActivityLog[]

  @@index([founderId])
  @@index([status])
}

model Feedback {
  id            String         @id @default(uuid())
  ideaId        String
  contributorId String
  body          String         @db.Text
  experienceTag String
  status        FeedbackStatus @default(PENDING)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  // Relations
  idea          Idea           @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  contributor   User           @relation(fields: [contributorId], references: [id])
  payout        Payout?

  @@index([ideaId])
  @@index([contributorId])
  @@index([status])
}

model Payout {
  id            String       @id @default(uuid())
  feedbackId    String       @unique
  ideaId        String
  contributorId String
  amount        Decimal      @db.Decimal(18, 8)
  currency      Currency
  txSignature   String?
  status        PayoutStatus @default(PENDING)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  // Relations
  feedback      Feedback     @relation(fields: [feedbackId], references: [id], onDelete: Cascade)
  idea          Idea         @relation(fields: [ideaId], references: [id])
  contributor   User         @relation(fields: [contributorId], references: [id])

  @@index([ideaId])
  @@index([contributorId])
  @@index([status])
}

model IdeaActivityLog {
  id        String   @id @default(uuid())
  ideaId    String
  actorId   String
  type      String
  metadata  Json?
  createdAt DateTime @default(now())

  // Relations
  idea      Idea     @relation(fields: [ideaId], references: [id], onDelete: Cascade)

  @@index([ideaId])
  @@index([actorId])
  @@index([createdAt])
}


